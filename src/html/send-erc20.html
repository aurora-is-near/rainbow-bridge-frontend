<div class="send-erc20" data-behavior="send-erc20" style="display: none">
  <div class="grid">
    <section class="balance">
      <header>
        <img alt="ethereum" src="img/eth-diamond-purple.png">
        Ethereum
      </header>
      <div>
        <span id="erc20name" class="dropdown" aria-live="polite">
          <button aria-controls="erc20name" data-behavior="ethErc20Name">🤔</button>
          <small class="left" style="width:27em; text-align:left">
            Contract <code data-behavior="ethErc20Address">🤔</code>
          </small>
        </span>
        balance
      </div>
      <strong class="jumbo" data-behavior="erc20Balance">🤔</strong>
      <footer>
        <img alt="account" src="img/account.svg">
        <code data-behavior="ethUser" class="clip">🤔</code>
      </footer>
    </section>
    <div data-behavior="notBridged" style="grid-column: span 2; margin: 1em 0 0 1em; display: none">
      <p>
        Not yet bridged!
      </p>
      <p>
        The
        <a href="https://github.com/near/rainbow-token-connector" target="_blank">Fungible Token Connector</a>
        allows sending any
        <a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank">ERC20</a>
        token to NEAR, but requires a one-time deploy of a "BridgeToken"
        <a href="https://docs.near.org/docs/roles/developer/contracts/intro#get-started" target="_blank">smart contract</a>.
        No one has deployed such a contract for this token yet.
      </p>
      <p>
        But you can!
      </p>
      <p>
        It will require about 30 Ⓝ to cover
        <a href="https://docs.near.org/docs/concepts/storage" target="_blank">storage fees</a>.
      </p>
      <p>
        <button>Bridge it!</button>
      </p>
    </div>
    <div data-behavior="balanceZero" style="grid-column: span 2; margin: 1em 0 0 1em">
      <p>
        Uh oh! You have no <span data-behavior="ethErc20Name">🤔</span>
        tokens. If you want to send some to yourself on NEAR, you'll need to
        get some on Ethereum first 😄
      </p>
      <p data-behavior="abound-token" style="display: none">
        You can <a href="https://chadoh.com/abundance-token" target="_blank">mint yourself more <span data-behavior="ethErc20Name">🤔</span></a>!
      </p>
      <p data-behavior="not-abound-token">
        Maybe you need to use a different account?
      </p>
    </div>
    <form data-behavior="balancePositive" style="display: none">
      <fieldset id="fieldset">
        <label for="amount">Send</label>
        <div style="display: flex">
          <input
            autocomplete="off"
            id="amount"
            name="amount"
            type="number"
            min="0"
            style="order: 1"
          />
          <button
            aria-controls="transfers"
            disabled
            id="toEth"
            name="toEth"
            style="border-radius: 5px 0 0 5px; order: 0"
            value="toEth"
          >
            <span class="visually-hidden">to Ethereum</span>
          </button>
          <button
            aria-controls="transfers"
            disabled
            id="toNear"
            name="toNear"
            style="border-radius: 0 5px 5px 0; order: 2"
            value="to NEAR"
          >
            <span class="visually-hidden">to NEAR</span>
          </button>
        </div>
      </fieldset>
    </form>
    <section class="balance" data-behavior="balancePositive" style="display: none">
      <header>
        <picture>
          <source srcset="img/near-icon-white.svg" media="(prefers-color-scheme: dark)">
          <img alt="near" src="img/near-icon-black.svg">
        </picture>
        NEAR
      </header>
      <div>
        <span id="nep21name" class="dropdown" aria-live="polite">
          <button aria-controls="nep21name" data-behavior="nearNep21Name">🤔</button>
          <small class="right" style="width:14em">
            Contract <code data-behavior="nearFunTokenAccount">🤔</code>
          </small>
        </span>
        balance
      </div>
      <strong class="jumbo" data-behavior="nep21Balance">🤔</strong>
      <footer>
        <img alt="account" src="img/account.svg">
        <code data-behavior="nearUser" class="clip">🤔</code>
      </footer>
    </section>
  </div>
  <p style="text-align: center; margin-top: 3rem">
    <button style="background: var(--error)" data-behavior="cancelSendingErc20">
      Cancel
    </button>
  </p>
</div>
<script>
  window.addEventListener('load', function addErc20ToNearHandlers () {
    document.querySelector('input#amount').oninput = function enableSubmit () {
      const amount = document.querySelector('[data-behavior=send-erc20] #amount')
      const value = Number(amount.value)
      const erc20Balance = Number(amount.dataset.erc20Balance)
      const nep21Balance = Number(amount.dataset.nep21Balance)

      const toNear = document.querySelector('[data-behavior=send-erc20] #toNear')
      if (value > 0 && value <= erc20Balance) {
        toNear.disabled = false
      } else {
        toNear.disabled = true
      }

      const toEth = document.querySelector('[data-behavior=send-erc20] #toEth')
      if (value > 0 && value <= nep21Balance) {
        toEth.disabled = false
      } else {
        toEth.disabled = true
      }
    }

    document.querySelector('[data-behavior=send-erc20] form').onsubmit = e => e.preventDefault()

    function handleForm ({ before, action }) {
      return async function onClick (event) {
        event.preventDefault()

        // get elements from the form using their id attribute
        const formElements = event.target.closest('form').elements
        const { amount, fieldset } = formElements

        // disable the form while the tokens get locked in Ethereum
        fieldset.disabled = true

        // allow each button, #toNear and #toEth, to do their own handling
        before(formElements)

        try {
          await action(Number(amount.value))
        } catch (e) {
          alert(
            'Something went wrong! ' +
            'Maybe you need to sign out and back in? ' +
            'Check your browser console for more info.'
          )
          throw e
        } finally {
          // re-enable the form, whether the call succeeded or failed
          fieldset.disabled = false
        }

        // if the call succeeded, reset the form
        amount.value = ''
        toEth.disabled = true
        toNear.disabled = true
        window.urlParams.clear('erc20')
        await window.render()
        const transfersButton = document.querySelector('#transfers button')
        transfersButton.click()
        transfersButton.focus()
      }
    }

    document.querySelector('[data-behavior=send-erc20] #toNear').onclick = handleForm({
      before: ({ toEth }) => { toEth.style.display = 'none' },
      action: amount => window.transfers.initiate({
        amount,
        callback: window.render,
        naturalErc20: window.urlParams.get('erc20')
      })
    })

    document.querySelector('[data-behavior=send-erc20] #toEth').onclick = handleForm({
      before: ({ toNear }) => { toNear.style.display = 'none' },
      action: amount => window.transfers.initiate({
        amount,
        callback: window.render,
        nep21FromErc20: getNep21Address(window.urlParams.get('ethErc20Address'))
      })
    })

    document.querySelector('[data-behavior=notBridged] button').onclick = function bridgeIt () {
      window.nearFungibleTokenFactory.deploy_bridge_token(
        { address: window.urlParams.get('erc20').replace('0x', '') },

        // Default gas limit used by near-api-js is 3e13, but this tx fails with
        // that number. Doubling it works. Maybe slightly less would also work,
        // but at min gas price of 100M yN, this will only amount to 0.006 $NEAR,
        // which is already negligible compared to the deposit.
        new window.BN(3e13).mul(new window.BN(2)),

        // Attach a deposit to compensate the BridgeTokenFactory contract for the
        // storage costs associated with deploying the new BridgeToken contract.
        // 30N for the base fee, plus .02 for for storing the name of the contract
        // Might not need full .02, but need more than .01, error message did not
        // include needed amount at time of writing.
        new window.BN(window.parseNearAmount('30.02'))
      )
    }

    document.querySelector('[data-behavior=cancelSendingErc20]').onclick = function cancelSendingErc20 () {
      window.urlParams.clear('erc20')
      window.render()
    }
  })

  async function renderErc20ToNear () {
    const ethErc20Address = window.urlParams.get('erc20')

    if (ethErc20Address) {
      window.show('send-erc20')
    } else {
      // user has not selected an ERC20 to send to NEAR; return early
      window.hide('send-erc20')
      return
    }

    // quickly clear displayed balances, since refetch can take a second
    const prevErc20Address = document.querySelector('[data-behavior=ethErc20Address]').innerText
    if (ethErc20Address !== prevErc20Address) {
      window.fill('erc20Balance').with('•••')
      window.fill('nep21Balance').with('•••')
    }

    const ethErc20Name = await window.getErc20Name(ethErc20Address)

    window.fill('ethErc20Name').with(ethErc20Name)
    window.fill('ethErc20Address').with(ethErc20Address)
    window.fill('nearNep21Name').with('n' + ethErc20Name)

    window.fill('ethUser').with(window.ethUserAddress)
    window.fill('nearUser').with(window.nearUserAddress)

    // how to get useful details about selected network in MetaMask?
    window.fill('ethNetworkName').with(await window.web3.eth.net.getNetworkType())

    const erc20Balance = await getErc20Balance(ethErc20Address)
    window.fill('erc20Balance').with(formatLargeNum(erc20Balance))
    const nep21Balance = await getNep21Balance(ethErc20Address)

    if (!erc20Balance && !nep21Balance) {
      window.hide('balancePositive')
      window.hide('notBridged')
      window.show('balanceZero')
      if (ethErc20Address === '0x3e13318e92F0C67Ca10f0120372E998d43E6a8E8') {
        window.show('abound-token')
        window.hide('not-abound-token')
      } else {
        window.hide('abound-token')
        window.show('not-abound-token')
      }
    } else {
      if (nep21Balance === null) {
        window.hide('balancePositive')
        window.hide('balanceZero')
        window.show('notBridged')
      } else {
        window.fill('nep21Balance').with(formatLargeNum(nep21Balance))
        window.hide('balanceZero')
        window.hide('notBridged')
        window.show('balancePositive')
        const toEth = document.querySelector('[data-behavior=send-erc20] #toEth')
        const toNear = document.querySelector('[data-behavior=send-erc20] #toNear')
        const amount = document.querySelector('[data-behavior=send-erc20] #amount')
        amount.max = Math.max(erc20Balance, nep21Balance)
        amount.dataset.nep21Balance = nep21Balance
        amount.dataset.erc20Balance = erc20Balance
        if (!erc20Balance) {
          toNear.style.display = 'none'
          amount.style.borderTopRightRadius = '5px'
          amount.style.borderBottomRightRadius = '5px'
        } else {
          toNear.style.display = ''
          amount.style.borderTopRightRadius = 0
          amount.style.borderBottomRightRadius = 0
        }
        if (!nep21Balance) {
          toEth.style.display = 'none'
          amount.style.borderTopLeftRadius = '5px'
          amount.style.borderBottomLeftRadius = '5px'
        } else {
          toEth.style.display = ''
          amount.style.borderTopLeftRadius = 0
          amount.style.borderBottomLeftRadius = 0
        }
      }
    }
  }

  const formatLargeNum = n => n >= 1e5 || (n < 1e-3 && n !== 0)
    ? n.toExponential(2)
    : new Intl.NumberFormat(undefined, { maximumSignificantDigits: 5 }).format(n)

  async function getErc20Balance (erc20Address) {
    const erc20Contract = new window.web3.eth.Contract(
      JSON.parse(process.env.ethErc20AbiText),
      erc20Address,
      { from: window.ethUserAddress }
    )

    return Number(
      await erc20Contract.methods.balanceOf(window.ethUserAddress).call()
    )
  }

  async function getNep21Balance (erc20Address) {
    const nep21 = await new window.NearContract(
      window.nearConnection.account(),
      getNep21Address(erc20Address),
      { viewMethods: ['get_balance'] }
    )

    return nep21.get_balance({ owner_id: window.nearUserAddress })
      .then(raw => Number(raw))
      .catch(() => null)
  }

  function getNep21Address (erc20Address) {
    return erc20Address.replace('0x', '').toLowerCase() +
      '.' +
      process.env.nearTokenFactoryAccount
  }

  window.renderers.push(renderErc20ToNear)
</script>
<style>
  .send-erc20 {
    margin: 4rem auto;
    max-width: 20em;
  }
  .send-erc20 .grid {
    align-items: stretch;
    grid-template-columns: repeat(3, minmax(10em, 1fr));
  }
  .send-erc20 .grid > * {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
  }
  .send-erc20 section {
    border-radius: 5px;
    border: 1px solid var(--gray);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0.5em 0.5em 0;
    position: relative;
    text-align: center;
  }
  .send-erc20 section header {
    position: absolute;
    top: -1.3em;
    left: 0;
  }
  .send-erc20 section header img {
    height: 1em;
  }
  .send-erc20 section button {
    padding: 0 0.25em;
  }
  .send-erc20 section footer {
    font-size: 0.8em;
  }
  .send-erc20 section footer img {
    width: 1em;
    vertical-align: bottom;
  }
  #toEth:after  { content: '↑' }
  #toNear:after { content: '↓' }
  @media(min-width: 650px) {
    .send-erc20 {
      max-width: 40em;
    }
    .send-erc20 .grid {
      display: grid;
    }
    #toEth:after  { content: '←' }
    #toNear:after { content: '→' }
  }
</style>
